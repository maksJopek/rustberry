#!/bin/sh
# Check if gh is installed
gh --version >/dev/null 2>/dev/null || { echo 'You need to install github client to use this script'; exit 0; }

# Check if user is loged in gh
gh auth status >/dev/null 2>/dev/null || { echo 'You need to login to gh to use this script (gh auth login)'; exit 0; }

# Get pull request description
echo "Add description (Y/n)"
read choice

if [[ ! "$choice" == "n" ]]; then
	# Text editors
	nvim ps-script-temp 2>/dev/null || \
	vim ps-script-temp 2>/dev/null || \
	vi ps-script-temp 2>/dev/null || \
	nano ps-script-temp 2>/dev/null || \
	{ echo "No text editor found"; exit 0; }

	user_desc="<br>$(cat pr-script-temp)" && rm pr-script-temp
fi


# Get pull request name
branch="$(git branch --show-current || git branch | grep \* | sed 's/\*\ //')"
pr_title="$branch"
echo "Title (default $pr_title)"
read user_pr

[[ "$user_pr" == "" ]] || pr_title="$user_pr"

# Get issue
issue="$(echo $branch | grep -oP '(?!\-)\d+(?=\|)') ($(echo $branch | grep -oP '(?<=\|).+'))"
echo "Issue (default $issue)"
read user_issue

[[ "$user_issue" == "" ]] || issue="$user_issue"

# Link to issue
desc="Close #$issue"

# Final check
echo "Title: $pr_title"
echo "Issue: $issue"
printf "Description: \"$desc\n$user_desc\"\n"
echo "Press anything to continue"
read

# Magic
gh pr create -t "$pr_title" -B develop -b "$desc$user_desc"
